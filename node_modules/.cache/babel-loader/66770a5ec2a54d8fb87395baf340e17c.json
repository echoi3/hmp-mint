{"ast":null,"code":"const SafeEventEmitter = require('@metamask/safe-event-emitter').default;\n\nconst {\n  createAsyncMiddleware,\n  createScaffoldMiddleware\n} = require('json-rpc-engine');\n\nconst createFilterMiddleware = require('./index.js');\n\nconst {\n  unsafeRandomBytes,\n  incrementHexInt\n} = require('./hexUtils.js');\n\nconst getBlocksForRange = require('./getBlocksForRange.js');\n\nmodule.exports = createSubscriptionMiddleware;\n\nfunction createSubscriptionMiddleware(_ref) {\n  let {\n    blockTracker,\n    provider\n  } = _ref;\n  // state and utilities for handling subscriptions\n  const subscriptions = {};\n  const filterManager = createFilterMiddleware({\n    blockTracker,\n    provider\n  }); // internal flag\n\n  let isDestroyed = false; // create subscriptionManager api object\n\n  const events = new SafeEventEmitter();\n  const middleware = createScaffoldMiddleware({\n    eth_subscribe: createAsyncMiddleware(subscribe),\n    eth_unsubscribe: createAsyncMiddleware(unsubscribe)\n  });\n  middleware.destroy = destroy;\n  return {\n    events,\n    middleware\n  };\n\n  async function subscribe(req, res) {\n    if (isDestroyed) throw new Error('SubscriptionManager - attempting to use after destroying');\n    const subscriptionType = req.params[0]; // subId is 16 byte hex string\n\n    const subId = unsafeRandomBytes(16); // create sub\n\n    let sub;\n\n    switch (subscriptionType) {\n      case 'newHeads':\n        sub = createSubNewHeads({\n          subId\n        });\n        break;\n\n      case 'logs':\n        const filterParams = req.params[1];\n        const filter = await filterManager.newLogFilter(filterParams);\n        sub = createSubFromFilter({\n          subId,\n          filter\n        });\n        break;\n\n      default:\n        throw new Error(`SubscriptionManager - unsupported subscription type \"${subscriptionType}\"`);\n    }\n\n    subscriptions[subId] = sub;\n    res.result = subId;\n    return;\n\n    function createSubNewHeads(_ref2) {\n      let {\n        subId\n      } = _ref2;\n      const sub = {\n        type: subscriptionType,\n        destroy: async () => {\n          blockTracker.removeListener('sync', sub.update);\n        },\n        update: async _ref3 => {\n          let {\n            oldBlock,\n            newBlock\n          } = _ref3;\n          // for newHeads\n          const toBlock = newBlock;\n          const fromBlock = incrementHexInt(oldBlock);\n          const rawBlocks = await getBlocksForRange({\n            provider,\n            fromBlock,\n            toBlock\n          });\n          const results = rawBlocks.map(normalizeBlock).filter(block => block !== null);\n          results.forEach(value => {\n            _emitSubscriptionResult(subId, value);\n          });\n        }\n      }; // check for subscription updates on new block\n\n      blockTracker.on('sync', sub.update);\n      return sub;\n    }\n\n    function createSubFromFilter(_ref4) {\n      let {\n        subId,\n        filter\n      } = _ref4;\n      filter.on('update', result => _emitSubscriptionResult(subId, result));\n      const sub = {\n        type: subscriptionType,\n        destroy: async () => {\n          return await filterManager.uninstallFilter(filter.idHex);\n        }\n      };\n      return sub;\n    }\n  }\n\n  async function unsubscribe(req, res) {\n    if (isDestroyed) throw new Error('SubscriptionManager - attempting to use after destroying');\n    const id = req.params[0];\n    const subscription = subscriptions[id]; // if missing, return \"false\" to indicate it was not removed\n\n    if (!subscription) {\n      res.result = false;\n      return;\n    } // cleanup subscription\n\n\n    delete subscriptions[id];\n    await subscription.destroy();\n    res.result = true;\n  }\n\n  function _emitSubscriptionResult(filterIdHex, value) {\n    events.emit('notification', {\n      jsonrpc: '2.0',\n      method: 'eth_subscription',\n      params: {\n        subscription: filterIdHex,\n        result: value\n      }\n    });\n  }\n\n  function destroy() {\n    events.removeAllListeners();\n\n    for (const id in subscriptions) {\n      subscriptions[id].destroy();\n      delete subscriptions[id];\n    }\n\n    isDestroyed = true;\n  }\n}\n\nfunction normalizeBlock(block) {\n  if (block === null || block === undefined) {\n    return null;\n  }\n\n  return {\n    hash: block.hash,\n    parentHash: block.parentHash,\n    sha3Uncles: block.sha3Uncles,\n    miner: block.miner,\n    stateRoot: block.stateRoot,\n    transactionsRoot: block.transactionsRoot,\n    receiptsRoot: block.receiptsRoot,\n    logsBloom: block.logsBloom,\n    difficulty: block.difficulty,\n    number: block.number,\n    gasLimit: block.gasLimit,\n    gasUsed: block.gasUsed,\n    nonce: block.nonce,\n    mixHash: block.mixHash,\n    timestamp: block.timestamp,\n    extraData: block.extraData\n  };\n}","map":{"version":3,"sources":["/Users/echoi33/Downloads/Source V2/node_modules/@coinbase/wallet-sdk/node_modules/eth-json-rpc-filters/subscriptionManager.js"],"names":["SafeEventEmitter","require","default","createAsyncMiddleware","createScaffoldMiddleware","createFilterMiddleware","unsafeRandomBytes","incrementHexInt","getBlocksForRange","module","exports","createSubscriptionMiddleware","blockTracker","provider","subscriptions","filterManager","isDestroyed","events","middleware","eth_subscribe","subscribe","eth_unsubscribe","unsubscribe","destroy","req","res","Error","subscriptionType","params","subId","sub","createSubNewHeads","filterParams","filter","newLogFilter","createSubFromFilter","result","type","removeListener","update","oldBlock","newBlock","toBlock","fromBlock","rawBlocks","results","map","normalizeBlock","block","forEach","value","_emitSubscriptionResult","on","uninstallFilter","idHex","id","subscription","filterIdHex","emit","jsonrpc","method","removeAllListeners","undefined","hash","parentHash","sha3Uncles","miner","stateRoot","transactionsRoot","receiptsRoot","logsBloom","difficulty","number","gasLimit","gasUsed","nonce","mixHash","timestamp","extraData"],"mappings":"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","sourcesContent":["const SafeEventEmitter = require('@metamask/safe-event-emitter').default\nconst { createAsyncMiddleware, createScaffoldMiddleware } = require('json-rpc-engine')\nconst createFilterMiddleware = require('./index.js')\nconst { unsafeRandomBytes, incrementHexInt } = require('./hexUtils.js')\nconst getBlocksForRange = require('./getBlocksForRange.js')\n\nmodule.exports = createSubscriptionMiddleware\n\n\nfunction createSubscriptionMiddleware({ blockTracker, provider }) {\n  // state and utilities for handling subscriptions\n  const subscriptions = {}\n  const filterManager = createFilterMiddleware({ blockTracker, provider })\n\n  // internal flag\n  let isDestroyed = false\n\n  // create subscriptionManager api object\n  const events = new SafeEventEmitter()\n  const middleware = createScaffoldMiddleware({\n    eth_subscribe: createAsyncMiddleware(subscribe),\n    eth_unsubscribe: createAsyncMiddleware(unsubscribe),\n  })\n  middleware.destroy = destroy\n  return { events, middleware }\n\n  async function subscribe(req, res) {\n\n    if (isDestroyed) throw new Error(\n      'SubscriptionManager - attempting to use after destroying'\n    )\n\n    const subscriptionType = req.params[0]\n    // subId is 16 byte hex string\n    const subId = unsafeRandomBytes(16)\n\n    // create sub\n    let sub\n    switch (subscriptionType) {\n      case 'newHeads':\n        sub = createSubNewHeads({ subId })\n        break\n      case 'logs':\n        const filterParams = req.params[1]\n        const filter = await filterManager.newLogFilter(filterParams)\n        sub = createSubFromFilter({ subId, filter })\n        break\n      default:\n        throw new Error(`SubscriptionManager - unsupported subscription type \"${subscriptionType}\"`)\n\n    }\n    subscriptions[subId] = sub\n\n    res.result = subId\n    return\n\n    function createSubNewHeads({ subId }) {\n      const sub = {\n        type: subscriptionType,\n        destroy: async () => {\n          blockTracker.removeListener('sync', sub.update)\n        },\n        update: async ({ oldBlock, newBlock }) => {\n          // for newHeads\n          const toBlock = newBlock\n          const fromBlock = incrementHexInt(oldBlock)\n          const rawBlocks = await getBlocksForRange({ provider, fromBlock, toBlock })\n          const results = rawBlocks.map(normalizeBlock).filter(block => block !== null)\n          results.forEach((value) => {\n            _emitSubscriptionResult(subId, value)\n          })\n        }\n      }\n      // check for subscription updates on new block\n      blockTracker.on('sync', sub.update)\n      return sub\n    }\n\n    function createSubFromFilter({ subId, filter }) {\n      filter.on('update', result => _emitSubscriptionResult(subId, result))\n      const sub = {\n        type: subscriptionType,\n        destroy: async () => {\n          return await filterManager.uninstallFilter(filter.idHex)\n        },\n      }\n      return sub\n    }\n  }\n\n  async function unsubscribe(req, res) {\n\n    if (isDestroyed) throw new Error(\n      'SubscriptionManager - attempting to use after destroying'\n    )\n\n    const id = req.params[0]\n    const subscription = subscriptions[id]\n    // if missing, return \"false\" to indicate it was not removed\n    if (!subscription) {\n      res.result = false\n      return\n    }\n    // cleanup subscription\n    delete subscriptions[id]\n    await subscription.destroy()\n    res.result = true\n  }\n\n  function _emitSubscriptionResult(filterIdHex, value) {\n    events.emit('notification', {\n      jsonrpc: '2.0',\n      method: 'eth_subscription',\n      params: {\n        subscription: filterIdHex,\n        result: value,\n      },\n    })\n  }\n\n  function destroy() {\n    events.removeAllListeners()\n    for (const id in subscriptions) {\n      subscriptions[id].destroy()\n      delete subscriptions[id]\n    }\n    isDestroyed = true\n  }\n}\n\nfunction normalizeBlock(block) {\n  if (block === null || block === undefined) {\n    return null;\n  }\n  return {\n    hash: block.hash,\n    parentHash: block.parentHash,\n    sha3Uncles: block.sha3Uncles,\n    miner: block.miner,\n    stateRoot: block.stateRoot,\n    transactionsRoot: block.transactionsRoot,\n    receiptsRoot: block.receiptsRoot,\n    logsBloom: block.logsBloom,\n    difficulty: block.difficulty,\n    number: block.number,\n    gasLimit: block.gasLimit,\n    gasUsed: block.gasUsed,\n    nonce: block.nonce,\n    mixHash: block.mixHash,\n    timestamp: block.timestamp,\n    extraData: block.extraData,\n  }\n}\n"]},"metadata":{},"sourceType":"script"}